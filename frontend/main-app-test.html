<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸»åº”ç”¨åŠŸèƒ½æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .test-section {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background: #2563eb;
      }
      .emergency-btn {
        background: #dc2626;
      }
      .emergency-btn:hover {
        background: #b91c1c;
      }
      .success {
        background: #10b981;
        color: white;
        padding: 8px;
        border-radius: 4px;
        margin: 5px 0;
      }
      .error {
        background: #ef4444;
        color: white;
        padding: 8px;
        border-radius: 4px;
        margin: 5px 0;
      }
      .info {
        background: #3b82f6;
        color: white;
        padding: 8px;
        border-radius: 4px;
        margin: 5px 0;
      }
      .logs {
        background: #1f2937;
        color: #f9fafb;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }
      iframe {
        width: 100%;
        height: 600px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <h1>Emergency Guardian - ä¸»åº”ç”¨åŠŸèƒ½æµ‹è¯•</h1>

    <div class="container">
      <h2>ğŸ¯ æµ‹è¯•ç›®æ ‡</h2>
      <p>éªŒè¯ä¸»åº”ç”¨çš„ä»¥ä¸‹åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š</p>
      <ul>
        <li>âœ… é’±åŒ…è¿æ¥æŒ‰é’®</li>
        <li>âœ… é¡µé¢å¯¼èˆªåŠŸèƒ½</li>
        <li>âœ… ç´§æ€¥æ±‚åŠ©æŒ‰é’®</li>
        <li>âœ… è°ƒè¯•é¢æ¿æ˜¾ç¤º</li>
      </ul>
    </div>

    <div class="container">
      <h2>ğŸ”§ å¿«é€Ÿæµ‹è¯•å·¥å…·</h2>

      <div class="test-section">
        <h3>é’±åŒ…è¿æ¥æµ‹è¯•</h3>
        <p>æµ‹è¯•MetaMaskè¿æ¥åŠŸèƒ½</p>
        <button onclick="testWalletConnection()">æµ‹è¯•é’±åŒ…è¿æ¥</button>
        <div id="walletResult"></div>
      </div>

      <div class="test-section">
        <h3>ä¸»åº”ç”¨è®¿é—®æµ‹è¯•</h3>
        <p>æµ‹è¯•ä¸»åº”ç”¨æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</p>
        <button onclick="testMainAppAccess()">æµ‹è¯•ä¸»åº”ç”¨è®¿é—®</button>
        <button onclick="openMainApp()">åœ¨æ–°çª—å£æ‰“å¼€ä¸»åº”ç”¨</button>
        <div id="accessResult"></div>
      </div>

      <div class="test-section">
        <h3>JavaScriptåŠŸèƒ½æµ‹è¯•</h3>
        <p>æµ‹è¯•ä¸»åº”ç”¨çš„JavaScriptæ˜¯å¦æ­£å¸¸åŠ è½½</p>
        <button onclick="testJavaScriptFunctions()">æµ‹è¯•JSåŠŸèƒ½</button>
        <div id="jsResult"></div>
      </div>
    </div>

    <div class="container">
      <h2>ğŸ–¥ï¸ ä¸»åº”ç”¨é¢„è§ˆ</h2>
      <p>ä¸‹é¢æ˜¯ä¸»åº”ç”¨çš„å†…åµŒé¢„è§ˆï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œæµ‹è¯•åŠŸèƒ½ï¼š</p>
      <iframe src="http://localhost:5173" id="mainAppFrame"></iframe>
      <div class="info">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
        <ol>
          <li>åœ¨ä¸Šæ–¹é¢„è§ˆä¸­ç‚¹å‡»å³ä¸Šè§’çš„"è¿æ¥é’±åŒ…"æŒ‰é’®</li>
          <li>è¿æ¥æˆåŠŸåï¼ŒæŸ¥çœ‹å·¦ä¸‹è§’æ˜¯å¦å‡ºç°è°ƒè¯•é¢æ¿</li>
          <li>ç‚¹å‡»"ç´§æ€¥æ±‚åŠ©"æŒ‰é’®æµ‹è¯•é¡µé¢å¯¼èˆª</li>
          <li>ç‚¹å‡»å…¶ä»–å¿«é€Ÿæ“ä½œæŒ‰é’®æµ‹è¯•åŠŸèƒ½</li>
        </ol>
      </div>
    </div>

    <div class="container">
      <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
      <div id="logs" class="logs">æµ‹è¯•å·¥å…·å·²åŠ è½½ï¼Œå¼€å§‹æµ‹è¯•...</div>
      <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <script>
      function log(message, type = "info") {
        const logsDiv = document.getElementById("logs");
        const timestamp = new Date().toLocaleTimeString();
        const prefix =
          type === "error"
            ? "âŒ"
            : type === "success"
            ? "âœ…"
            : type === "warning"
            ? "âš ï¸"
            : "â„¹ï¸";
        logsDiv.innerHTML += `\n[${timestamp}] ${prefix} ${message}`;
        logsDiv.scrollTop = logsDiv.scrollHeight;
        console.log(message);
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = "æ—¥å¿—å·²æ¸…é™¤";
      }

      function updateResult(elementId, message, type = "info") {
        const element = document.getElementById(elementId);
        const className =
          type === "success" ? "success" : type === "error" ? "error" : "info";
        element.innerHTML = `<div class="${className}">${message}</div>`;
      }

      async function testWalletConnection() {
        try {
          log("å¼€å§‹æµ‹è¯•é’±åŒ…è¿æ¥...", "info");
          updateResult("walletResult", "æµ‹è¯•ä¸­...", "info");

          if (typeof window.ethereum === "undefined") {
            throw new Error("MetaMaskæœªå®‰è£…");
          }

          // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
          const accounts = await window.ethereum.request({
            method: "eth_accounts",
          });

          if (accounts.length > 0) {
            const chainId = await window.ethereum.request({
              method: "eth_chainId",
            });
            const chainIdDecimal = parseInt(chainId, 16);

            updateResult(
              "walletResult",
              `âœ… é’±åŒ…å·²è¿æ¥<br>åœ°å€: ${accounts[0]}<br>ç½‘ç»œ: Chain ID ${chainIdDecimal}`,
              "success"
            );
            log(
              `é’±åŒ…å·²è¿æ¥: ${accounts[0]}, Chain ID: ${chainIdDecimal}`,
              "success"
            );
          } else {
            // å°è¯•è¿æ¥
            const newAccounts = await window.ethereum.request({
              method: "eth_requestAccounts",
            });
            if (newAccounts.length > 0) {
              updateResult(
                "walletResult",
                `âœ… é’±åŒ…è¿æ¥æˆåŠŸ<br>åœ°å€: ${newAccounts[0]}`,
                "success"
              );
              log(`é’±åŒ…è¿æ¥æˆåŠŸ: ${newAccounts[0]}`, "success");
            } else {
              throw new Error("ç”¨æˆ·æ‹’ç»è¿æ¥");
            }
          }
        } catch (error) {
          updateResult(
            "walletResult",
            `âŒ è¿æ¥å¤±è´¥: ${error.message}`,
            "error"
          );
          log(`é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testMainAppAccess() {
        try {
          log("å¼€å§‹æµ‹è¯•ä¸»åº”ç”¨è®¿é—®...", "info");
          updateResult("accessResult", "æµ‹è¯•ä¸­...", "info");

          const response = await fetch("http://localhost:5173");
          if (response.ok) {
            const html = await response.text();

            // æ£€æŸ¥HTMLå†…å®¹
            if (html.includes("<!doctype html>")) {
              updateResult(
                "accessResult",
                "âœ… ä¸»åº”ç”¨è®¿é—®æ­£å¸¸<br>HTMLé¡µé¢åŠ è½½æˆåŠŸ",
                "success"
              );
              log("ä¸»åº”ç”¨è®¿é—®æµ‹è¯•é€šè¿‡", "success");

              // æ£€æŸ¥æ˜¯å¦åŒ…å«Reactç›¸å…³å†…å®¹
              if (html.includes("react") || html.includes("vite")) {
                log("æ£€æµ‹åˆ°React/Viteç›¸å…³å†…å®¹", "success");
              }
            } else {
              updateResult("accessResult", "âš ï¸ ä¸»åº”ç”¨è¿”å›å¼‚å¸¸å†…å®¹", "error");
              log("ä¸»åº”ç”¨è¿”å›å†…å®¹å¼‚å¸¸", "error");
            }
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          updateResult(
            "accessResult",
            `âŒ è®¿é—®å¤±è´¥: ${error.message}`,
            "error"
          );
          log(`ä¸»åº”ç”¨è®¿é—®å¤±è´¥: ${error.message}`, "error");
        }
      }

      function testJavaScriptFunctions() {
        log("å¼€å§‹æµ‹è¯•JavaScriptåŠŸèƒ½...", "info");
        updateResult("jsResult", "æµ‹è¯•ä¸­...", "info");

        // æµ‹è¯•åŸºæœ¬JavaScriptåŠŸèƒ½
        try {
          // æµ‹è¯•ç°ä»£JavaScriptç‰¹æ€§
          const testArrowFunction = () => "arrow function works";
          const testPromise = new Promise((resolve) =>
            resolve("promise works")
          );
          const testAsync = async () => "async works";

          if (testArrowFunction() === "arrow function works") {
            log("ç®­å¤´å‡½æ•°æµ‹è¯•é€šè¿‡", "success");
          }

          testPromise.then((result) => {
            if (result === "promise works") {
              log("Promiseæµ‹è¯•é€šè¿‡", "success");
            }
          });

          testAsync().then((result) => {
            if (result === "async works") {
              log("Async/Awaitæµ‹è¯•é€šè¿‡", "success");
            }
          });

          // æµ‹è¯•DOMæ“ä½œ
          const testDiv = document.createElement("div");
          testDiv.textContent = "DOM test";
          if (testDiv.textContent === "DOM test") {
            log("DOMæ“ä½œæµ‹è¯•é€šè¿‡", "success");
          }

          updateResult(
            "jsResult",
            "âœ… JavaScriptåŠŸèƒ½æ­£å¸¸<br>ç°ä»£JSç‰¹æ€§æ”¯æŒè‰¯å¥½",
            "success"
          );
          log("JavaScriptåŠŸèƒ½æµ‹è¯•å®Œæˆ", "success");
        } catch (error) {
          updateResult(
            "jsResult",
            `âŒ JavaScriptæµ‹è¯•å¤±è´¥: ${error.message}`,
            "error"
          );
          log(`JavaScriptæµ‹è¯•å¤±è´¥: ${error.message}`, "error");
        }
      }

      function openMainApp() {
        log("åœ¨æ–°çª—å£æ‰“å¼€ä¸»åº”ç”¨...", "info");
        const newWindow = window.open("http://localhost:5173", "_blank");

        if (newWindow) {
          log("ä¸»åº”ç”¨å·²åœ¨æ–°çª—å£æ‰“å¼€", "success");

          // ç»™ç”¨æˆ·ä¸€äº›æµ‹è¯•æŒ‡å¯¼
          setTimeout(() => {
            log("è¯·åœ¨æ–°çª—å£ä¸­æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½:", "info");
            log('1. ç‚¹å‡»å³ä¸Šè§’"è¿æ¥é’±åŒ…"æŒ‰é’®', "info");
            log("2. æŸ¥çœ‹å·¦ä¸‹è§’è°ƒè¯•é¢æ¿", "info");
            log('3. ç‚¹å‡»"ç´§æ€¥æ±‚åŠ©"æŒ‰é’®', "info");
            log("4. æµ‹è¯•å…¶ä»–å¯¼èˆªæŒ‰é’®", "info");
          }, 1000);
        } else {
          log("æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œå¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢", "error");
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œä¸€äº›æµ‹è¯•
      window.addEventListener("load", () => {
        log("ä¸»åº”ç”¨æµ‹è¯•å·¥å…·å·²åŠ è½½", "info");
        log("æ‚¨å¯ä»¥ä½¿ç”¨ä¸Šæ–¹çš„æµ‹è¯•æŒ‰é’®æ¥éªŒè¯å„é¡¹åŠŸèƒ½", "info");

        // è‡ªåŠ¨æµ‹è¯•ä¸»åº”ç”¨è®¿é—®
        setTimeout(testMainAppAccess, 1000);

        // æ£€æŸ¥MetaMask
        if (typeof window.ethereum !== "undefined") {
          log("æ£€æµ‹åˆ°MetaMask", "success");
        } else {
          log("æœªæ£€æµ‹åˆ°MetaMaskï¼Œè¯·å®‰è£…MetaMaskæ‰©å±•", "error");
        }
      });

      // ç›‘å¬iframeåŠ è½½äº‹ä»¶
      document.getElementById("mainAppFrame").addEventListener("load", () => {
        log("ä¸»åº”ç”¨iframeåŠ è½½å®Œæˆ", "success");
      });

      document.getElementById("mainAppFrame").addEventListener("error", () => {
        log("ä¸»åº”ç”¨iframeåŠ è½½å¤±è´¥", "error");
      });
    </script>
  </body>
</html>
