<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Final Navigation Test - Emergency Guardian</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #1e3a8a, #7c3aed, #dc2626);
        color: white;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(15px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .header h1 {
        font-size: 2.5rem;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .status-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .status-card h3 {
        margin: 0 0 15px 0;
        color: #fbbf24;
      }
      .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .status-item:last-child {
        border-bottom: none;
      }
      .status-value {
        font-weight: bold;
      }
      .status-value.success {
        color: #10b981;
      }
      .status-value.error {
        color: #ef4444;
      }
      .status-value.warning {
        color: #f59e0b;
      }
      .status-value.info {
        color: #3b82f6;
      }

      .button {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        cursor: pointer;
        margin: 10px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
      }
      .button:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }
      .button.success {
        background: linear-gradient(135deg, #10b981, #059669);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }
      .button.success:hover {
        background: linear-gradient(135deg, #059669, #047857);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      }
      .button.primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }
      .button.primary:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }

      .test-section {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid #fbbf24;
      }
      .test-section h3 {
        margin: 0 0 15px 0;
        color: #fbbf24;
      }

      .log {
        background: rgba(0, 0, 0, 0.6);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .log-entry {
        margin: 5px 0;
        padding: 3px 0;
      }
      .log-entry.success {
        color: #10b981;
      }
      .log-entry.error {
        color: #ef4444;
      }
      .log-entry.info {
        color: #3b82f6;
      }
      .log-entry.warning {
        color: #f59e0b;
      }

      .instructions {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.2),
          rgba(16, 185, 129, 0.2)
        );
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }
      .instructions h3 {
        margin: 0 0 15px 0;
        color: #60a5fa;
      }
      .instructions ol {
        margin: 0;
        padding-left: 20px;
      }
      .instructions li {
        margin: 8px 0;
        line-height: 1.5;
      }

      .fix-summary {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.2),
          rgba(34, 197, 94, 0.2)
        );
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }
      .fix-summary h3 {
        margin: 0 0 15px 0;
        color: #34d399;
      }
      .fix-summary ul {
        margin: 0;
        padding-left: 20px;
      }
      .fix-summary li {
        margin: 8px 0;
        line-height: 1.5;
      }

      .pulse {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸš¨ Emergency Guardian</h1>
        <p>Navigation Fix - Final Test</p>
      </div>

      <div class="status-grid">
        <div class="status-card">
          <h3>ğŸ”§ System Status</h3>
          <div class="status-item">
            <span>Frontend Server:</span>
            <span id="frontend-status" class="status-value">æ£€æµ‹ä¸­...</span>
          </div>
          <div class="status-item">
            <span>Build Status:</span>
            <span class="status-value success">âœ… æˆåŠŸ</span>
          </div>
          <div class="status-item">
            <span>Navigation Fix:</span>
            <span class="status-value success">âœ… å·²åº”ç”¨</span>
          </div>
          <div class="status-item">
            <span>Components:</span>
            <span class="status-value success">âœ… å®Œæ•´</span>
          </div>
        </div>

        <div class="status-card">
          <h3>ğŸ“Š Test Results</h3>
          <div class="status-item">
            <span>Direct Access:</span>
            <span id="direct-test-status" class="status-value">æœªæµ‹è¯•</span>
          </div>
          <div class="status-item">
            <span>Navigation Test:</span>
            <span id="nav-test-status" class="status-value">æœªæµ‹è¯•</span>
          </div>
          <div class="status-item">
            <span>Emergency Page:</span>
            <span id="emergency-test-status" class="status-value">æœªæµ‹è¯•</span>
          </div>
          <div class="status-item">
            <span>Overall Status:</span>
            <span id="overall-status" class="status-value">å‡†å¤‡ä¸­</span>
          </div>
        </div>
      </div>

      <div class="fix-summary">
        <h3>ğŸ”§ Applied Navigation Fixes</h3>
        <ul>
          <li>
            <strong>Router Hook Fix:</strong> ç§»é™¤äº†å¯¼è‡´æ— é™é‡æ¸²æŸ“çš„ä¾èµ–é¡¹
          </li>
          <li><strong>Render Key System:</strong> æ·»åŠ äº†å¼ºåˆ¶é‡æ–°æ¸²æŸ“æœºåˆ¶</li>
          <li><strong>State Update Order:</strong> ä¼˜åŒ–äº†å¯¼èˆªçŠ¶æ€æ›´æ–°é¡ºåº</li>
          <li>
            <strong>Component Key Prop:</strong>
            åœ¨App.tsxä¸­æ·»åŠ äº†keyå±æ€§å¼ºåˆ¶é‡æ¸²æŸ“
          </li>
          <li><strong>Build Verification:</strong> ç¡®è®¤æ‰€æœ‰ç»„ä»¶ç¼–è¯‘æˆåŠŸ</li>
        </ul>
      </div>

      <div class="test-section">
        <h3>ğŸ§ª Automated Tests</h3>
        <div style="text-align: center">
          <button class="button primary" onclick="runAllTests()">
            è¿è¡Œæ‰€æœ‰æµ‹è¯•
          </button>
          <button class="button" onclick="testFrontendAccess()">
            æµ‹è¯•å‰ç«¯è®¿é—®
          </button>
          <button class="button" onclick="testDirectEmergencyAccess()">
            æµ‹è¯•ç´§æ€¥é¡µé¢ç›´æ¥è®¿é—®
          </button>
          <button class="button success" onclick="openMainAppForManualTest()">
            æ‰“å¼€ä¸»åº”ç”¨æ‰‹åŠ¨æµ‹è¯•
          </button>
        </div>
      </div>

      <div class="instructions">
        <h3>ğŸ“‹ Manual Test Instructions</h3>
        <ol>
          <li>
            <strong>ç‚¹å‡» "æ‰“å¼€ä¸»åº”ç”¨æ‰‹åŠ¨æµ‹è¯•"</strong> -
            è¿™å°†åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ä¸»åº”ç”¨
          </li>
          <li><strong>ç­‰å¾…åº”ç”¨åŠ è½½å®Œæˆ</strong> - åº”è¯¥çœ‹åˆ°ä»ªè¡¨æ¿é¡µé¢</li>
          <li><strong>ç‚¹å‡» "ç´§æ€¥æ±‚åŠ©" æŒ‰é’®</strong> - è¿™æ˜¯çº¢è‰²çš„å¤§æŒ‰é’®</li>
          <li><strong>éªŒè¯é¡µé¢åˆ‡æ¢</strong> - åº”è¯¥çœ‹åˆ°ç´§æ€¥æ“ä½œä¸­å¿ƒé¡µé¢</li>
          <li><strong>æ£€æŸ¥URLå˜åŒ–</strong> - URLåº”è¯¥å˜ä¸º /emergency</li>
          <li>
            <strong>æµ‹è¯•å…¶ä»–å¯¼èˆª</strong> - å°è¯•ç‚¹å‡»å…¶ä»–æŒ‰é’®ï¼ˆç›‘æŠ¤äººã€è®¾ç½®ç­‰ï¼‰
          </li>
          <li><strong>æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—</strong> - æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹æ—¥å¿—</li>
        </ol>
      </div>

      <div class="test-section">
        <h3>ğŸ“ Expected vs Previous Behavior</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
          <div>
            <h4 style="color: #ef4444">âŒ Previous (Broken):</h4>
            <ul>
              <li>ç‚¹å‡»æŒ‰é’®åURLä¼šå˜åŒ–</li>
              <li>ä½†é¡µé¢å†…å®¹ä¸ä¼šæ›´æ–°</li>
              <li>æ§åˆ¶å°æ˜¾ç¤ºè·¯ç”±å˜åŒ–æ—¥å¿—</li>
              <li>éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢</li>
            </ul>
          </div>
          <div>
            <h4 style="color: #10b981">âœ… Fixed (Expected):</h4>
            <ul>
              <li>ç‚¹å‡»æŒ‰é’®åURLå˜åŒ–</li>
              <li>é¡µé¢å†…å®¹ç«‹å³æ›´æ–°</li>
              <li>æ§åˆ¶å°æ˜¾ç¤ºå¯¼èˆªå®Œæˆæ—¥å¿—</li>
              <li>æ— éœ€åˆ·æ–°é¡µé¢</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="log" id="log"></div>

      <div style="text-align: center; margin-top: 30px">
        <button class="button" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        <button class="button primary" onclick="exportTestResults()">
          å¯¼å‡ºæµ‹è¯•ç»“æœ
        </button>
      </div>
    </div>

    <script>
      let logElement = document.getElementById("log");
      let testResults = {
        timestamp: new Date().toISOString(),
        tests: {},
        logs: [],
      };

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        logElement.appendChild(logEntry);
        logElement.scrollTop = logElement.scrollHeight;

        // Store in results
        testResults.logs.push({
          timestamp,
          message,
          type,
        });

        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      function clearLogs() {
        logElement.innerHTML = "";
        testResults.logs = [];
        log("æ—¥å¿—å·²æ¸…é™¤", "info");
      }

      function updateStatus(elementId, text, type) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = text;
          element.className = `status-value ${type}`;
        }
      }

      async function testFrontendAccess() {
        log("ğŸ” æµ‹è¯•å‰ç«¯æœåŠ¡å™¨è®¿é—®...", "info");

        try {
          const response = await fetch("http://localhost:5173/", {
            method: "HEAD",
            cache: "no-cache",
          });

          if (response.ok) {
            updateStatus("frontend-status", "âœ… è¿è¡Œä¸­", "success");
            log("âœ… å‰ç«¯æœåŠ¡å™¨è®¿é—®æˆåŠŸ", "success");
            testResults.tests.frontendAccess = {
              status: "success",
              response: response.status,
            };
            return true;
          } else {
            updateStatus(
              "frontend-status",
              `âŒ é”™è¯¯ ${response.status}`,
              "error"
            );
            log(`âŒ å‰ç«¯æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`, "error");
            testResults.tests.frontendAccess = {
              status: "error",
              response: response.status,
            };
            return false;
          }
        } catch (error) {
          updateStatus("frontend-status", "âŒ ç¦»çº¿", "error");
          log(`âŒ å‰ç«¯æœåŠ¡å™¨æ— æ³•è®¿é—®: ${error.message}`, "error");
          log('ğŸ’¡ è¯·ç¡®ä¿è¿è¡Œäº† "npm run dev" å‘½ä»¤', "warning");
          testResults.tests.frontendAccess = {
            status: "error",
            error: error.message,
          };
          return false;
        }
      }

      async function testDirectEmergencyAccess() {
        log("ğŸ” æµ‹è¯•ç´§æ€¥é¡µé¢ç›´æ¥è®¿é—®...", "info");

        const isServerRunning = await testFrontendAccess();
        if (!isServerRunning) {
          updateStatus("direct-test-status", "âŒ æœåŠ¡å™¨ç¦»çº¿", "error");
          return false;
        }

        try {
          const emergencyUrl = "http://localhost:5173/emergency";
          log(`ğŸ“¡ å°è¯•è®¿é—®: ${emergencyUrl}`, "info");

          const response = await fetch(emergencyUrl, {
            method: "HEAD",
            cache: "no-cache",
          });

          if (response.ok) {
            updateStatus("direct-test-status", "âœ… æˆåŠŸ", "success");
            updateStatus("emergency-test-status", "âœ… å¯è®¿é—®", "success");
            log("âœ… ç´§æ€¥é¡µé¢ç›´æ¥è®¿é—®æˆåŠŸ", "success");
            testResults.tests.directEmergencyAccess = { status: "success" };
            return true;
          } else {
            updateStatus(
              "direct-test-status",
              `âŒ é”™è¯¯ ${response.status}`,
              "error"
            );
            log(`âŒ ç´§æ€¥é¡µé¢è®¿é—®å¤±è´¥: ${response.status}`, "error");
            testResults.tests.directEmergencyAccess = {
              status: "error",
              response: response.status,
            };
            return false;
          }
        } catch (error) {
          updateStatus("direct-test-status", "âŒ å¤±è´¥", "error");
          log(`âŒ ç´§æ€¥é¡µé¢æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          testResults.tests.directEmergencyAccess = {
            status: "error",
            error: error.message,
          };
          return false;
        }
      }

      async function runAllTests() {
        log("ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•...", "info");
        updateStatus("overall-status", "ğŸ”„ æµ‹è¯•ä¸­", "warning");

        const results = [];

        // Test 1: Frontend Access
        results.push(await testFrontendAccess());

        // Test 2: Direct Emergency Access
        results.push(await testDirectEmergencyAccess());

        // Summary
        const successCount = results.filter((r) => r).length;
        const totalCount = results.length;

        if (successCount === totalCount) {
          updateStatus("overall-status", "âœ… å…¨éƒ¨é€šè¿‡", "success");
          updateStatus("nav-test-status", "âœ… å‡†å¤‡å°±ç»ª", "success");
          log(
            `ğŸ‰ æ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡ (${successCount}/${totalCount})`,
            "success"
          );
          log("ğŸ“± ç°åœ¨å¯ä»¥è¿›è¡Œæ‰‹åŠ¨å¯¼èˆªæµ‹è¯•", "info");
        } else {
          updateStatus(
            "overall-status",
            `âš ï¸ ${successCount}/${totalCount} é€šè¿‡`,
            "warning"
          );
          log(`âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ (${successCount}/${totalCount})`, "warning");
        }

        testResults.tests.summary = {
          total: totalCount,
          passed: successCount,
          status: successCount === totalCount ? "success" : "partial",
        };
      }

      function openMainAppForManualTest() {
        log("ğŸš€ æ‰“å¼€ä¸»åº”ç”¨è¿›è¡Œæ‰‹åŠ¨å¯¼èˆªæµ‹è¯•...", "info");

        const mainAppUrl = "http://localhost:5173/";
        log(`ğŸ“± æ‰“å¼€ä¸»åº”ç”¨: ${mainAppUrl}`, "info");

        const newWindow = window.open(
          mainAppUrl,
          "_blank",
          "width=1200,height=800"
        );
        if (newWindow) {
          log("âœ… ä¸»åº”ç”¨å·²åœ¨æ–°çª—å£æ‰“å¼€", "success");
          log("ğŸ“‹ è¯·æŒ‰ç…§æµ‹è¯•è¯´æ˜è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•:", "info");
          log("   1. ç­‰å¾…åº”ç”¨åŠ è½½å®Œæˆ", "info");
          log('   2. ç‚¹å‡»çº¢è‰²çš„ "ç´§æ€¥æ±‚åŠ©" æŒ‰é’®', "info");
          log("   3. éªŒè¯é¡µé¢æ˜¯å¦åˆ‡æ¢åˆ°ç´§æ€¥æ“ä½œä¸­å¿ƒ", "info");
          log("   4. æ£€æŸ¥URLæ˜¯å¦å˜ä¸º /emergency", "info");
          log("   5. æµ‹è¯•å…¶ä»–å¯¼èˆªæŒ‰é’®", "info");

          updateStatus("nav-test-status", "ğŸ”„ æ‰‹åŠ¨æµ‹è¯•ä¸­", "warning");

          // Set up a timer to remind user
          setTimeout(() => {
            log("â° æé†’: è¯·åœ¨æ–°çª—å£ä¸­æµ‹è¯•å¯¼èˆªåŠŸèƒ½", "warning");
          }, 5000);

          testResults.tests.manualTest = {
            status: "initiated",
            timestamp: new Date().toISOString(),
          };
        } else {
          log("âŒ æ— æ³•æ‰“å¼€æ–°çª—å£ï¼ˆå¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢ï¼‰", "error");
          log("ğŸ’¡ è¯·æ‰‹åŠ¨è®¿é—®: http://localhost:5173/", "info");
          testResults.tests.manualTest = { status: "blocked" };
        }
      }

      function exportTestResults() {
        const results = {
          ...testResults,
          exportTime: new Date().toISOString(),
          userAgent: navigator.userAgent,
          url: window.location.href,
        };

        const blob = new Blob([JSON.stringify(results, null, 2)], {
          type: "application/json",
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `navigation-test-results-${new Date()
          .toISOString()
          .slice(0, 19)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        log("ğŸ“„ æµ‹è¯•ç»“æœå·²å¯¼å‡º", "success");
      }

      // Initialize
      window.addEventListener("load", () => {
        log("ğŸš€ Navigation Fix Test é¡µé¢å·²åŠ è½½", "info");
        log("ğŸ”§ Navigation fixes have been applied:", "info");
        log("   âœ… Router hook dependency fix", "success");
        log("   âœ… Render key system added", "success");
        log("   âœ… State update order optimized", "success");
        log("   âœ… Component key prop added", "success");
        log("   âœ… Build verification passed", "success");

        // Auto-run tests after a short delay
        setTimeout(() => {
          log("ğŸ”„ è‡ªåŠ¨è¿è¡Œåˆå§‹æµ‹è¯•...", "info");
          runAllTests();
        }, 2000);
      });

      // Update time periodically
      setInterval(() => {
        const timeElements = document.querySelectorAll("[data-time]");
        timeElements.forEach((el) => {
          el.textContent = new Date().toLocaleTimeString();
        });
      }, 1000);
    </script>
  </body>
</html>
