<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emergency Guardian - è¯Šæ–­å·¥å…·</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-weight: bold;
      }
      .success {
        background: #d1fae5;
        color: #065f46;
      }
      .error {
        background: #fee2e2;
        color: #991b1b;
      }
      .warning {
        background: #fef3c7;
        color: #92400e;
      }
      .info {
        background: #dbeafe;
        color: #1e40af;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #2563eb;
      }
      .logs {
        background: #1f2937;
        color: #f9fafb;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>Emergency Guardian - ç³»ç»Ÿè¯Šæ–­</h1>

    <div class="container">
      <h2>ğŸ” ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
      <div id="systemStatus">æ£€æŸ¥ä¸­...</div>
      <button onclick="runDiagnostics()">é‡æ–°æ£€æŸ¥</button>
      <button onclick="openMainApp()">æ‰“å¼€ä¸»åº”ç”¨</button>
      <button onclick="testWalletConnection()">æµ‹è¯•é’±åŒ…è¿æ¥</button>
    </div>

    <div class="container">
      <h2>ğŸ“‹ æ£€æŸ¥ç»“æœ</h2>
      <div id="results"></div>
    </div>

    <div class="container">
      <h2>ğŸ“ è¯Šæ–­æ—¥å¿—</h2>
      <div id="logs" class="logs">æ­£åœ¨åˆå§‹åŒ–è¯Šæ–­å·¥å…·...</div>
      <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <script>
      function log(message, type = "info") {
        const logsDiv = document.getElementById("logs");
        const timestamp = new Date().toLocaleTimeString();
        const prefix =
          type === "error"
            ? "âŒ"
            : type === "success"
            ? "âœ…"
            : type === "warning"
            ? "âš ï¸"
            : "â„¹ï¸";
        logsDiv.innerHTML += `\n[${timestamp}] ${prefix} ${message}`;
        logsDiv.scrollTop = logsDiv.scrollHeight;
        console.log(message);
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = "æ—¥å¿—å·²æ¸…é™¤";
      }

      function updateStatus(message, type = "info") {
        const statusDiv = document.getElementById("systemStatus");
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      function addResult(title, status, details = "") {
        const resultsDiv = document.getElementById("results");
        const statusClass =
          status === "success"
            ? "success"
            : status === "error"
            ? "error"
            : status === "warning"
            ? "warning"
            : "info";
        const statusIcon =
          status === "success"
            ? "âœ…"
            : status === "error"
            ? "âŒ"
            : status === "warning"
            ? "âš ï¸"
            : "â„¹ï¸";

        resultsDiv.innerHTML += `
                <div class="status ${statusClass}">
                    ${statusIcon} <strong>${title}</strong><br>
                    ${details}
                </div>
            `;
      }

      async function runDiagnostics() {
        log("å¼€å§‹ç³»ç»Ÿè¯Šæ–­...", "info");
        updateStatus("æ­£åœ¨è¿è¡Œè¯Šæ–­...", "info");
        document.getElementById("results").innerHTML = "";

        // 1. æ£€æŸ¥å‰ç«¯åº”ç”¨
        try {
          const response = await fetch("http://localhost:5173");
          if (response.ok) {
            addResult(
              "å‰ç«¯åº”ç”¨",
              "success",
              "ä¸»åº”ç”¨æ­£åœ¨è¿è¡Œ (http://localhost:5173)"
            );
            log("å‰ç«¯åº”ç”¨æ£€æŸ¥é€šè¿‡", "success");
          } else {
            addResult(
              "å‰ç«¯åº”ç”¨",
              "error",
              `HTTP ${response.status} - åº”ç”¨å¯èƒ½æœ‰é—®é¢˜`
            );
            log(`å‰ç«¯åº”ç”¨è¿”å›é”™è¯¯: ${response.status}`, "error");
          }
        } catch (error) {
          addResult(
            "å‰ç«¯åº”ç”¨",
            "error",
            `æ— æ³•è¿æ¥åˆ°å‰ç«¯åº”ç”¨: ${error.message}`
          );
          log(`å‰ç«¯åº”ç”¨æ£€æŸ¥å¤±è´¥: ${error.message}`, "error");
        }

        // 2. æ£€æŸ¥AIæœåŠ¡
        try {
          const response = await fetch("http://localhost:8001/health");
          const data = await response.json();
          if (data.status === "healthy") {
            addResult("AIä»£ç†æœåŠ¡", "success", "AIæœåŠ¡æ­£å¸¸è¿è¡Œï¼Œæ‰€æœ‰ç»„ä»¶å¥åº·");
            log("AIæœåŠ¡æ£€æŸ¥é€šè¿‡", "success");
          } else {
            addResult("AIä»£ç†æœåŠ¡", "warning", `æœåŠ¡çŠ¶æ€: ${data.status}`);
            log(`AIæœåŠ¡çŠ¶æ€å¼‚å¸¸: ${data.status}`, "warning");
          }
        } catch (error) {
          addResult(
            "AIä»£ç†æœåŠ¡",
            "error",
            `æ— æ³•è¿æ¥åˆ°AIæœåŠ¡: ${error.message}`
          );
          log(`AIæœåŠ¡æ£€æŸ¥å¤±è´¥: ${error.message}`, "error");
        }

        // 3. æ£€æŸ¥MetaMask
        if (typeof window.ethereum !== "undefined") {
          addResult("MetaMask", "success", "MetaMaskå·²å®‰è£…å¹¶å¯ç”¨");
          log("MetaMaskæ£€æŸ¥é€šè¿‡", "success");

          // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
          try {
            const accounts = await window.ethereum.request({
              method: "eth_accounts",
            });
            if (accounts.length > 0) {
              addResult("é’±åŒ…è¿æ¥", "success", `å·²è¿æ¥è´¦æˆ·: ${accounts[0]}`);
              log(`é’±åŒ…å·²è¿æ¥: ${accounts[0]}`, "success");

              // æ£€æŸ¥ç½‘ç»œ
              const chainId = await window.ethereum.request({
                method: "eth_chainId",
              });
              const chainIdDecimal = parseInt(chainId, 16);
              if (chainIdDecimal === 11155111) {
                addResult("ç½‘ç»œè®¾ç½®", "success", "Sepoliaæµ‹è¯•ç½‘ - æ­£ç¡®");
                log("ç½‘ç»œè®¾ç½®æ­£ç¡®: Sepoliaæµ‹è¯•ç½‘", "success");
              } else {
                addResult(
                  "ç½‘ç»œè®¾ç½®",
                  "warning",
                  `å½“å‰ç½‘ç»œ: Chain ID ${chainIdDecimal} (å»ºè®®åˆ‡æ¢åˆ°Sepolia)`
                );
                log(`ç½‘ç»œè®¾ç½®: Chain ID ${chainIdDecimal}`, "warning");
              }
            } else {
              addResult("é’±åŒ…è¿æ¥", "warning", "é’±åŒ…æœªè¿æ¥ï¼Œéœ€è¦æ‰‹åŠ¨è¿æ¥");
              log("é’±åŒ…æœªè¿æ¥", "warning");
            }
          } catch (error) {
            addResult(
              "é’±åŒ…è¿æ¥",
              "error",
              `æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´¥: ${error.message}`
            );
            log(`æ£€æŸ¥é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, "error");
          }
        } else {
          addResult("MetaMask", "error", "MetaMaskæœªå®‰è£…ï¼Œè¯·å®‰è£…MetaMaskæ‰©å±•");
          log("MetaMaskæœªå®‰è£…", "error");
        }

        // 4. æ£€æŸ¥æ™ºèƒ½åˆçº¦
        try {
          if (typeof window.ethereum !== "undefined") {
            const contractAddress =
              "0x6af445EA589D8f550a3D1dacf34745071a4D5b4F";
            const code = await window.ethereum.request({
              method: "eth_getCode",
              params: [contractAddress, "latest"],
            });

            if (code && code !== "0x" && code !== "0x0") {
              addResult(
                "æ™ºèƒ½åˆçº¦",
                "success",
                `Emergency Managementåˆçº¦å·²éƒ¨ç½² (${contractAddress})`
              );
              log("æ™ºèƒ½åˆçº¦æ£€æŸ¥é€šè¿‡", "success");
            } else {
              addResult("æ™ºèƒ½åˆçº¦", "error", "åˆçº¦æœªéƒ¨ç½²æˆ–åœ°å€é”™è¯¯");
              log("æ™ºèƒ½åˆçº¦æ£€æŸ¥å¤±è´¥: åˆçº¦ä¸å­˜åœ¨", "error");
            }
          } else {
            addResult("æ™ºèƒ½åˆçº¦", "warning", "æ— æ³•æ£€æŸ¥åˆçº¦ - MetaMaskæœªå®‰è£…");
            log("æ— æ³•æ£€æŸ¥æ™ºèƒ½åˆçº¦: MetaMaskæœªå®‰è£…", "warning");
          }
        } catch (error) {
          addResult("æ™ºèƒ½åˆçº¦", "error", `æ£€æŸ¥åˆçº¦å¤±è´¥: ${error.message}`);
          log(`æ™ºèƒ½åˆçº¦æ£€æŸ¥å¤±è´¥: ${error.message}`, "error");
        }

        updateStatus("è¯Šæ–­å®Œæˆï¼æŸ¥çœ‹ä¸‹æ–¹ç»“æœ", "success");
        log("ç³»ç»Ÿè¯Šæ–­å®Œæˆ", "success");
      }

      function openMainApp() {
        log("æ‰“å¼€ä¸»åº”ç”¨...", "info");
        window.open("http://localhost:5173", "_blank");
      }

      async function testWalletConnection() {
        try {
          if (typeof window.ethereum === "undefined") {
            throw new Error("MetaMaskæœªå®‰è£…");
          }

          log("å¼€å§‹æµ‹è¯•é’±åŒ…è¿æ¥...", "info");

          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });

          if (accounts.length > 0) {
            log(`é’±åŒ…è¿æ¥æˆåŠŸ: ${accounts[0]}`, "success");

            // æ£€æŸ¥ä½™é¢
            const balanceHex = await window.ethereum.request({
              method: "eth_getBalance",
              params: [accounts[0], "latest"],
            });
            const balanceWei = parseInt(balanceHex, 16);
            const balanceEth = (balanceWei / Math.pow(10, 18)).toFixed(4);

            log(`è´¦æˆ·ä½™é¢: ${balanceEth} ETH`, "info");

            updateStatus(`é’±åŒ…è¿æ¥æˆåŠŸï¼åœ°å€: ${accounts[0]}`, "success");
          } else {
            throw new Error("æ²¡æœ‰å¯ç”¨çš„è´¦æˆ·");
          }
        } catch (error) {
          log(`é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, "error");
          updateStatus(`é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, "error");
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
      window.addEventListener("load", () => {
        log("è¯Šæ–­å·¥å…·å·²åŠ è½½", "info");
        setTimeout(runDiagnostics, 1000);
      });
    </script>
  </body>
</html>
